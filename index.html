<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#3b82f6">
  <meta name="description" content="A minimal, privacy-first personal start page">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè†</text></svg>">
  <title>Start</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-bg-hover: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-primary: rgba(255, 255, 255, 0.92);
      --text-secondary: rgba(255, 255, 255, 0.6);
      --text-muted: rgba(255, 255, 255, 0.4);
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --danger: #ef4444;
      --success: #22c55e;
      --warning: #f59e0b;
      --radius: 16px;
      --radius-sm: 12px;
      --radius-xs: 8px;
      --blur: 12px;
    }
    [data-theme="light"] {
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-bg-hover: rgba(255, 255, 255, 0.95);
      --glass-border: rgba(0, 0, 0, 0.08);
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
    }
    .bg-layer {
      position: fixed; inset: 0; z-index: -1;
      background: #111827;
    }
    .bg-image {
      position: fixed; inset: 0; z-index: -1;
      background-size: cover; background-position: center;
      opacity: 0; transition: opacity 0.8s;
    }
    .bg-image.loaded { opacity: 1; }
    .bg-overlay { position: fixed; inset: 0; z-index: -1; background: transparent; }
    
    /* Light theme */
    [data-theme="light"] .bg-layer { background: #fffbf5; }
    [data-theme="light"] .card { 
      background: #fafafa;
      border: 1px solid #eee;
    }
    [data-theme="light"] .quick-links { 
      background: rgba(0,0,0,0.03);
    }
    [data-theme="light"] .quick-link { background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    [data-theme="light"] .quick-link:hover { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    [data-theme="light"] .quick-link .key { background: #f3f4f6; color: var(--text-muted); }
    [data-theme="light"] .countdown-item { background: #fff; border: 1px solid #eee; border-left: 3px solid var(--accent); }
    [data-theme="light"] .todo-item { background: #fff; border: 1px solid #eee; }
    [data-theme="light"] .vocab-stat { background: #fff; border: 1px solid #eee; }
    [data-theme="light"] .vocab-display { background: #fff; border: 1px solid #eee; }
    [data-theme="light"] .todo-tabs { background: #eee; }
    [data-theme="light"] .todo-tab.active { background: #fff; }
    [data-theme="light"] .icon-btn { 
      background: rgba(0,0,0,0.04);
    }
    [data-theme="light"] .icon-btn:hover { background: rgba(0,0,0,0.08); }
    [data-theme="light"] .search-box input {
      background: #fafafa;
      border: 1px solid #eee;
    }
    [data-theme="light"] .todo-input {
      background: #fff;
      border: 1px solid #eee;
    }
    [data-theme="light"] .modal {
      background: #fff;
      border: 1px solid #eee;
    }
    [data-theme="light"] .form-input,
    [data-theme="light"] .form-textarea {
      background: #fafafa;
      border: 1px solid #eee;
    }
    [data-theme="light"] .settings-action-btn,
    [data-theme="light"] .export-option {
      background: #fafafa;
      border: 1px solid #eee;
    }
    [data-theme="light"] .settings-action-btn:hover,
    [data-theme="light"] .export-option:hover {
      background: #f5f5f5;
    }
    [data-theme="light"] .add-link-btn,
    [data-theme="light"] .batch-link-btn {
      background: rgba(0,0,0,0.04);
    }
    [data-theme="light"] .vocab-btn {
      background: #fff;
      border: 1px solid #eee;
    }
    [data-theme="light"] .vocab-btn:hover { background: #f5f5f5; }
    [data-theme="light"] .bg-option { border: 2px solid #eee; }
    [data-theme="light"] .bg-option.active { border-color: var(--accent); }

    .container {
      min-height: 100vh; display: flex; flex-direction: column;
      padding: 20px 24px; max-width: 1400px; margin: 0 auto;
    }

    /* Header */
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px; padding: 8px 0;
    }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .search-box { position: relative; }
    .search-box input {
      width: 180px; padding: 10px 14px 10px 38px;
      background: rgba(255,255,255,0.06);
      border: none; border-radius: 20px;
      color: var(--text-primary); font-size: 13px; outline: none;
      transition: all 0.25s ease;
    }
    .search-box input::placeholder { color: var(--text-muted); }
    .search-box input:focus { 
      width: 240px; 
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
    }
    .search-box svg {
      position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
      width: 16px; height: 16px; color: var(--text-muted);
    }
    [data-theme="light"] .search-box input {
      background: rgba(0,0,0,0.04);
    }
    [data-theme="light"] .search-box input:focus {
      background: #fff;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .header-actions { display: flex; gap: 8px; }
    .icon-btn {
      width: 38px; height: 38px; border-radius: 50%;
      background: rgba(255,255,255,0.06);
      border: none; color: var(--text-secondary);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); }

    /* Quick Links Bar */
    .quick-links {
      display: flex; align-items: center; gap: 8px;
      padding: 12px 16px; margin-bottom: 10px;
      background: rgba(255,255,255,0.04);
      border: none; border-radius: 20px;
      overflow-x: auto; flex-wrap: wrap;
    }
    .quick-link {
      display: flex; align-items: center; gap: 6px;
      padding: 8px 12px; background: rgba(255,255,255,0.06);
      border: none; border-radius: 20px;
      text-decoration: none; color: var(--text-primary);
      font-size: 12px; font-weight: 500; white-space: nowrap;
      transition: all 0.2s; cursor: grab;
    }
    .quick-link:hover { background: rgba(255,255,255,0.12); transform: translateY(-1px); }
    .quick-link.dragging { opacity: 0.5; cursor: grabbing; }
    .quick-link.drag-over { background: var(--accent); transform: scale(1.05); }
    .quick-link img { width: 16px; height: 16px; border-radius: 4px; pointer-events: none; }
    .quick-link .key { font-size: 9px; color: var(--text-muted); background: rgba(255,255,255,0.1); padding: 2px 5px; border-radius: 4px; font-family: monospace; }
    .link-divider { width: 1px; height: 20px; background: var(--glass-border); margin: 0 4px; }
    .add-link-btn {
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,255,255,0.06); border: none;
      color: var(--text-muted); cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .add-link-btn:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); }
    .batch-link-btn {
      padding: 6px 12px; border-radius: 16px;
      background: rgba(255,255,255,0.06); border: none;
      color: var(--text-muted); cursor: pointer; font-size: 11px;
      transition: all 0.2s; flex-shrink: 0;
    }
    .batch-link-btn:hover { background: rgba(255,255,255,0.12); color: var(--text-primary); }

    /* Hero - Left aligned compact */
    .hero {
      display: none;
    }
    
    /* Time in header */
    .header-time {
      display: flex; align-items: center; gap: 16px;
    }
    .clock { font-size: 2.5rem; font-weight: 300; letter-spacing: -1px; color: var(--text-primary); }
    .time-info { display: flex; flex-direction: column; }
    .greeting { font-size: 0.9rem; color: var(--text-secondary); font-weight: 500; }
    .date { font-size: 0.75rem; color: var(--text-muted); }
    [data-theme="light"] .clock { color: #333; }
    
    /* Header weather widget */
    .header-weather {
      display: flex; align-items: center; gap: 6px;
      padding: 6px 12px; margin-left: 16px;
      background: rgba(255,255,255,0.06); border-radius: 20px;
      cursor: pointer; transition: all 0.2s;
    }
    .header-weather:hover { background: rgba(255,255,255,0.1); }
    .hw-icon { font-size: 1.2rem; }
    .hw-temp { font-size: 1rem; font-weight: 600; color: var(--text-primary); }
    .hw-desc { font-size: 0.75rem; color: var(--text-muted); }
    .hw-location { font-size: 0.65rem; color: var(--text-muted); margin-left: 4px; }
    [data-theme="light"] .header-weather { background: rgba(0,0,0,0.05); }
    [data-theme="light"] .header-weather:hover { background: rgba(0,0,0,0.08); }
    
    /* Header right section */
    .header-right { display: flex; align-items: center; gap: 12px; }

    /* Dashboard */
    .dashboard {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: 14px; flex: 1; align-content: start;
    }
    @media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 700px) { .dashboard { grid-template-columns: 1fr; } }

    /* Card */
    .card {
      background: var(--glass-bg); backdrop-filter: blur(var(--blur));
      border: 1px solid var(--glass-border); border-radius: var(--radius);
      padding: 14px; display: flex; flex-direction: column;
      transition: all 0.2s;
    }
    .card:hover { background: var(--glass-bg-hover); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-title { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.8px; }
    .card-action {
      width: 28px; height: 28px; border-radius: 8px;
      background: transparent; border: none; color: var(--text-muted);
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .card-action:hover { background: var(--glass-bg); color: var(--text-primary); }

    /* Countdown - Grid of small rounded cards */
    .countdown-list { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
      gap: 8px; 
    }
    .countdown-item {
      display: flex; flex-direction: column; align-items: center;
      padding: 12px 8px; background: rgba(255,255,255,0.04);
      border-radius: 16px; text-align: center;
      position: relative; transition: all 0.2s;
    }
    .countdown-item:hover { background: rgba(255,255,255,0.08); transform: translateY(-2px); }
    .countdown-item.urgent { background: rgba(239, 68, 68, 0.1); }
    .countdown-item.soon { background: rgba(245, 158, 11, 0.1); }
    .countdown-info { margin-bottom: 4px; }
    .countdown-name { font-size: 12px; font-weight: 600; margin-bottom: 2px; }
    .countdown-date { font-size: 10px; color: var(--text-muted); }
    .countdown-time { display: flex; flex-direction: column; align-items: center; }
    .countdown-days { font-size: 1.5rem; font-weight: 700; color: var(--accent); line-height: 1; }
    .countdown-item.urgent .countdown-days { color: var(--danger); }
    .countdown-item.soon .countdown-days { color: var(--warning); }
    .countdown-label { font-size: 10px; color: var(--text-muted); }
    .countdown-delete { 
      position: absolute; top: 4px; right: 4px;
      opacity: 0; transition: opacity 0.15s; 
      width: 18px; height: 18px;
    }
    .countdown-item:hover .countdown-delete { opacity: 1; }
    [data-theme="light"] .countdown-item { background: #fff; border: 1px solid #eee; }
    [data-theme="light"] .countdown-item:hover { background: #fafafa; }
    [data-theme="light"] .countdown-item.urgent { background: #fef2f2; border-color: #fecaca; }
    [data-theme="light"] .countdown-item.soon { background: #fffbeb; border-color: #fed7aa; }

    /* Todo */
    .todo-tabs {
      display: flex; gap: 2px; margin-bottom: 10px;
      background: rgba(255,255,255,0.04); padding: 4px; border-radius: 12px;
    }
    .todo-tab {
      flex: 1; padding: 8px; background: transparent; border: none;
      border-radius: 10px; font-size: 11px; font-weight: 500;
      color: var(--text-muted); cursor: pointer; transition: all 0.2s;
    }
    .todo-tab.active { background: rgba(255,255,255,0.08); color: var(--text-primary); }
    .todo-input-row { display: flex; gap: 6px; margin-bottom: 8px; }
    .todo-input {
      flex: 1; padding: 10px 14px; background: rgba(255,255,255,0.04);
      border: 1px solid transparent; border-radius: 12px;
      color: var(--text-primary); font-size: 13px; outline: none;
    }
    .todo-input:focus { border-color: var(--accent); }
    .todo-input::placeholder { color: var(--text-muted); }
    .todo-add-btn {
      padding: 10px 16px; background: var(--accent); border: none;
      border-radius: 12px; color: white; font-size: 14px;
      font-weight: 600; cursor: pointer;
    }
    .todo-add-btn:hover { background: var(--accent-hover); }
    .todo-list { display: flex; flex-direction: column; gap: 4px; max-height: 180px; overflow-y: auto; }
    .todo-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px; background: rgba(255,255,255,0.03);
      border-radius: 12px; cursor: grab; transition: all 0.2s;
    }
    .todo-item.dragging { opacity: 0.5; cursor: grabbing; }
    .todo-item.drag-over { background: var(--accent); transform: scale(1.02); }
    .todo-tab.drag-over { background: var(--accent) !important; color: white !important; }
    .todo-checkbox {
      width: 16px; height: 16px; border: 2px solid var(--text-muted);
      border-radius: 50%; cursor: pointer; flex-shrink: 0;
      display: flex; align-items: center; justify-content: center;
    }
    .todo-checkbox:hover { border-color: var(--accent); }
    .todo-checkbox.checked { background: var(--success); border-color: var(--success); }
    .todo-checkbox.checked::after { content: "‚úì"; color: white; font-size: 10px; }
    .todo-text { flex: 1; font-size: 13px; }
    .todo-item.completed .todo-text { text-decoration: line-through; color: var(--text-muted); }
    .todo-actions { opacity: 0; }
    .todo-item:hover .todo-actions { opacity: 1; }
    .todo-action-btn { width: 20px; height: 20px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; }
    .todo-action-btn:hover { color: var(--danger); }

    /* Vocab - Modern Flashcard Design */
    .vocab-card { grid-column: span 1; }
    
    /* Top bar with streak and stats */
    .vocab-top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .vocab-streak-badge {
      display: flex; align-items: center; gap: 4px;
      padding: 4px 10px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(239,68,68,0.1));
      border-radius: 16px; font-size: 12px; font-weight: 600;
    }
    .vocab-streak-badge .fire { font-size: 14px; }
    .vocab-streak-badge .count { color: var(--warning); }
    .vocab-xp-badge {
      display: flex; align-items: center; gap: 4px;
      padding: 4px 10px; background: rgba(34,197,94,0.1);
      border-radius: 16px; font-size: 11px; color: var(--success); font-weight: 600;
    }
    
    /* Progress bar */
    .vocab-progress-bar { height: 3px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-bottom: 12px; overflow: hidden; }
    .vocab-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 2px; transition: width 0.3s ease; }
    
    /* Main flashcard */
    .vocab-flashcard {
      position: relative; min-height: 120px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px; padding: 16px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.2s ease;
    }
    .vocab-flashcard:hover { background: rgba(255,255,255,0.05); }
    .vocab-flashcard:active { transform: scale(0.99); }
    
    .vocab-word {
      font-size: 1.5rem; font-weight: 700; letter-spacing: -0.3px;
      margin-bottom: 4px; text-align: center; color: var(--text-primary);
    }
    .vocab-phonetic {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 12px; color: var(--text-muted);
      padding: 2px 8px; background: rgba(255,255,255,0.05);
      border-radius: 12px; cursor: pointer; transition: all 0.2s;
    }
    .vocab-phonetic:hover { background: rgba(59,130,246,0.2); color: var(--accent); }
    .vocab-phonetic .sound-icon { font-size: 11px; }
    
    .vocab-divider {
      width: 40px; height: 2px; margin: 10px 0;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0; transition: opacity 0.2s;
    }
    .vocab-divider.show { opacity: 1; }
    
    .vocab-meaning {
      font-size: 13px; color: var(--text-secondary); text-align: center;
      max-width: 100%; line-height: 1.5;
      opacity: 0; transform: translateY(5px);
      transition: all 0.2s ease;
    }
    .vocab-meaning.show { opacity: 1; transform: translateY(0); }
    
    .vocab-extra {
      margin-top: 8px; width: 100%;
      opacity: 0; transform: translateY(5px);
      transition: all 0.2s ease 0.05s;
    }
    .vocab-extra.show { opacity: 1; transform: translateY(0); }
    
    .vocab-example {
      font-size: 11px; color: var(--text-muted); font-style: italic;
      padding: 8px 10px; background: rgba(59,130,246,0.08);
      border-radius: 8px; border-left: 2px solid var(--accent);
      text-align: left; margin-bottom: 6px;
    }
    .vocab-synonyms {
      display: flex; flex-wrap: wrap; gap: 4px; justify-content: center;
    }
    .vocab-synonyms span {
      padding: 2px 8px; background: rgba(255,255,255,0.06);
      border-radius: 10px; font-size: 10px; color: var(--text-secondary);
    }
    
    /* Tap hint */
    .vocab-tap-hint {
      position: absolute; bottom: 8px;
      font-size: 10px; color: var(--text-muted);
      display: flex; align-items: center; gap: 3px;
      opacity: 0.5;
    }
    .vocab-tap-hint.hidden { display: none; }
    
    /* Card counter */
    .vocab-counter {
      position: absolute; top: 8px; right: 10px;
      font-size: 10px; color: var(--text-muted);
    }
    
    /* Mastery indicator */
    .vocab-mastery {
      position: absolute; top: 8px; left: 10px;
      display: flex; gap: 2px;
    }
    .vocab-mastery-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(255,255,255,0.15);
    }
    .vocab-mastery-dot.filled { background: var(--success); }
    .vocab-mastery-dot.current { background: var(--accent); }
    
    /* Rating buttons */
    .vocab-actions {
      display: flex; justify-content: center; gap: 8px;
      margin-top: 10px;
    }
    .vocab-btn {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 8px 12px; min-width: 56px;
      border: none; border-radius: 10px;
      font-size: 10px; font-weight: 600; cursor: pointer;
      transition: all 0.15s ease;
    }
    .vocab-btn .icon { font-size: 16px; }
    .vocab-btn.forgot { background: rgba(239,68,68,0.12); color: var(--danger); }
    .vocab-btn.forgot:hover { background: rgba(239,68,68,0.25); }
    .vocab-btn.hard { background: rgba(245,158,11,0.12); color: var(--warning); }
    .vocab-btn.hard:hover { background: rgba(245,158,11,0.25); }
    .vocab-btn.good { background: rgba(34,197,94,0.12); color: var(--success); }
    .vocab-btn.good:hover { background: rgba(34,197,94,0.25); }
    .vocab-btn.easy { background: rgba(59,130,246,0.12); color: var(--accent); }
    .vocab-btn.easy:hover { background: rgba(59,130,246,0.25); }
    
    .vocab-btn-reveal {
      width: 100%; padding: 10px;
      background: var(--accent);
      border: none; border-radius: 10px;
      color: white; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .vocab-btn-reveal:hover { background: var(--accent-hover); }
    
    /* Complete state */
    .vocab-complete { text-align: center; padding: 20px 10px; }
    .vocab-complete-icon { font-size: 32px; margin-bottom: 8px; }
    .vocab-complete-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; color: var(--success); }
    .vocab-complete-text { font-size: 12px; color: var(--text-secondary); }
    
    /* Header actions */
    .vocab-header-actions { display: flex; gap: 4px; }
    
    /* Light theme */
    [data-theme="light"] .vocab-flashcard { background: #fff; border-color: #eee; }
    [data-theme="light"] .vocab-phonetic { background: #f3f4f6; }
    [data-theme="light"] .vocab-streak-badge { background: linear-gradient(135deg, rgba(245,158,11,0.1), rgba(239,68,68,0.05)); }

    /* ========== Mobile Responsive ========== */
    @media (max-width: 700px) {
      .container { padding: 12px 14px; }
      
      /* Header mobile */
      .header { flex-wrap: wrap; gap: 10px; }
      .header-left { width: 100%; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
      .header-time { gap: 10px; }
      .clock { font-size: 2rem; }
      .greeting { font-size: 0.8rem; }
      .date { font-size: 0.7rem; }
      .header-weather { margin-left: 0; padding: 4px 10px; }
      .hw-icon { font-size: 1rem; }
      .hw-temp { font-size: 0.9rem; }
      .hw-desc { font-size: 0.7rem; }
      .header-right { width: 100%; justify-content: space-between; }
      .search-box { flex: 1; }
      .search-box input { width: 100%; }
      .search-box input:focus { width: 100%; }
      .header-actions { position: static; }
      .icon-btn { width: 34px; height: 34px; }
      
      /* Quick links mobile */
      .quick-links { padding: 10px 12px; gap: 6px; border-radius: 16px; }
      .quick-link { padding: 6px 10px; font-size: 11px; border-radius: 16px; }
      .quick-link img { width: 14px; height: 14px; }
      .quick-link .key { display: none; }
      .add-link-btn, .batch-link-btn { display: none; }
      
      /* Cards mobile */
      .card { padding: 12px; border-radius: 14px; }
      .card-header { margin-bottom: 8px; }
      .card-title { font-size: 0.65rem; }
      .card-action { width: 26px; height: 26px; }
      
      /* Countdown mobile */
      .countdown-list { grid-template-columns: repeat(2, 1fr); gap: 6px; }
      .countdown-item { padding: 10px 6px; border-radius: 12px; }
      .countdown-name { font-size: 11px; }
      .countdown-days { font-size: 1.3rem; }
      
      /* Todo mobile */
      .todo-tabs { padding: 3px; border-radius: 10px; }
      .todo-tab { padding: 6px; font-size: 10px; border-radius: 8px; }
      .todo-input { padding: 8px 12px; font-size: 12px; border-radius: 10px; }
      .todo-add-btn { padding: 8px 14px; border-radius: 10px; }
      .todo-item { padding: 8px 10px; border-radius: 10px; }
      .todo-text { font-size: 12px; }
      
      /* Daily quote mobile */
      .daily-quote { margin-bottom: 8px; }
      .daily-quote .quote-text { font-size: 11px; }
      .quote-actions { opacity: 1; }
      
      /* Vocab mobile */
      .vocab-top-bar { margin-bottom: 8px; }
      .vocab-streak-badge { padding: 3px 8px; font-size: 11px; border-radius: 12px; }
      .vocab-streak-badge .fire { font-size: 12px; }
      .vocab-xp-badge { padding: 3px 8px; font-size: 10px; border-radius: 12px; }
      .vocab-progress-bar { height: 2px; margin-bottom: 10px; }
      .vocab-flashcard { min-height: 100px; padding: 14px 12px; border-radius: 12px; }
      .vocab-word { font-size: 1.3rem; }
      .vocab-phonetic { font-size: 11px; padding: 2px 6px; border-radius: 10px; }
      .vocab-phonetic .sound-icon { font-size: 10px; }
      .vocab-meaning { font-size: 12px; }
      .vocab-divider { width: 30px; margin: 8px 0; }
      .vocab-example { font-size: 10px; padding: 6px 8px; border-radius: 6px; }
      .vocab-synonyms span { padding: 2px 6px; font-size: 9px; border-radius: 8px; }
      .vocab-counter { font-size: 9px; top: 6px; right: 8px; }
      .vocab-mastery { top: 6px; left: 8px; gap: 2px; }
      .vocab-mastery-dot { width: 5px; height: 5px; }
      .vocab-tap-hint { font-size: 9px; bottom: 6px; }
      .vocab-actions { gap: 6px; margin-top: 8px; }
      .vocab-btn { padding: 6px 8px; min-width: 48px; border-radius: 8px; font-size: 9px; }
      .vocab-btn .icon { font-size: 14px; }
      .vocab-btn-reveal { padding: 8px; font-size: 11px; border-radius: 8px; }
      .vocab-complete { padding: 16px 8px; }
      .vocab-complete-icon { font-size: 28px; }
      .vocab-complete-title { font-size: 14px; }
      .vocab-complete-text { font-size: 11px; }
      
      /* Modal mobile */
      .modal { margin: 16px; padding: 18px; border-radius: 18px; max-width: calc(100% - 32px); }
      .modal-title { font-size: 0.9rem; }
      .form-input { padding: 10px 14px; font-size: 13px; }
      .btn { padding: 10px 16px; font-size: 12px; }
    }
    
    /* Extra small screens */
    @media (max-width: 380px) {
      .container { padding: 10px 10px; }
      .clock { font-size: 1.7rem; }
      .header-time { gap: 8px; }
      .quick-links { padding: 8px 10px; }
      .quick-link { padding: 5px 8px; font-size: 10px; }
      .countdown-list { grid-template-columns: 1fr 1fr; }
      .vocab-btn { min-width: 42px; padding: 5px 6px; }
      .vocab-btn .icon { font-size: 12px; }
      .vocab-word { font-size: 1.2rem; }
    }
    
    /* Mobile performance: reduce expensive effects */
    @media (max-width: 700px) {
      .card { backdrop-filter: blur(8px); }
      .modal { backdrop-filter: blur(10px); }
    }
    
    /* Safe area for notched phones */
    @supports (padding: max(0px)) {
      @media (max-width: 700px) {
        .container { 
          padding-left: max(14px, env(safe-area-inset-left));
          padding-right: max(14px, env(safe-area-inset-right));
          padding-bottom: max(16px, env(safe-area-inset-bottom));
        }
      }
    }
    
    /* Touch-friendly minimum tap targets */
    @media (pointer: coarse) {
      .card-action { min-width: 44px; min-height: 44px; }
      .icon-btn { min-width: 44px; min-height: 44px; }
      .todo-checkbox { min-width: 20px; min-height: 20px; }
      .vocab-btn { min-height: 44px; }
      .vocab-btn-reveal { min-height: 44px; }
    }

    /* Footer */
    .footer { display: none; }
    .footer-btn { display: none; }
    .footer-btn:hover { color: var(--text-primary); }
    
    /* Settings data actions */
    .settings-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--glass-border); }
    .settings-section-title { font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .settings-actions { display: flex; flex-direction: column; gap: 8px; }
    .settings-action-btn {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; background: rgba(255,255,255,0.03);
      border: 1px solid var(--glass-border); border-radius: 12px;
      color: var(--text-primary); font-size: 13px; cursor: pointer;
      transition: all 0.15s; text-align: left;
    }
    .settings-action-btn:hover { background: rgba(255,255,255,0.06); border-color: var(--accent); }
    .settings-action-btn.danger:hover { border-color: var(--danger); color: var(--danger); }
    .settings-action-icon { font-size: 16px; width: 20px; text-align: center; }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      backdrop-filter: blur(6px); display: flex;
      align-items: center; justify-content: center; z-index: 1000;
      opacity: 0; visibility: hidden; transition: all 0.2s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--glass-bg); backdrop-filter: blur(24px);
      border: 1px solid var(--glass-border); border-radius: 24px;
      padding: 24px; width: 100%; max-width: 400px;
      transform: scale(0.95); transition: transform 0.2s;
    }
    .modal-overlay.active .modal { transform: scale(1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .modal-title { font-size: 1rem; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; border: none; background: transparent; color: var(--text-muted); cursor: pointer; border-radius: 8px; transition: all 0.2s; }
    .modal-close:hover { background: rgba(255,255,255,0.1); color: var(--text-primary); }
    .form-group { margin-bottom: 12px; }
    .form-label { display: block; font-size: 11px; font-weight: 500; color: var(--text-muted); margin-bottom: 4px; text-transform: uppercase; }
    .form-input {
      width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border); border-radius: 12px;
      color: var(--text-primary); font-size: 13px; outline: none;
    }
    .form-input:focus { border-color: var(--accent); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
    .btn { padding: 10px 20px; border-radius: 12px; font-size: 13px; cursor: pointer; font-weight: 500; }
    .btn-secondary { background: transparent; border: 1px solid var(--glass-border); color: var(--text-primary); }
    .btn-primary { background: var(--accent); border: none; color: white; }

    /* Empty */
    .empty-state { text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px; }

    /* Settings BG */
    .bg-selector { display: flex; gap: 8px; flex-wrap: wrap; }
    .bg-option { width: 44px; height: 44px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .bg-option:hover { transform: scale(1.08); }
    .bg-option.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    .bg-option.gradient-1 { background: #111827; }
    .bg-option.gradient-2 { background: #1e1b4b; }
    .bg-option.gradient-3 { background: #0c4a6e; }
    .bg-option.gradient-4 { background: #14532d; }
    .bg-option.light-1 { background: #fffbf5; }
    .bg-option.light-2 { background: #fff; }
    .bg-option.light-3 { background: #f8fafc; }
    .bg-option.light-4 { background: #fef7f7; }

    /* Textarea for batch */
    .form-textarea {
      width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border); border-radius: 12px;
      color: var(--text-primary); font-size: 12px; outline: none;
      resize: vertical; min-height: 120px; font-family: inherit; line-height: 1.5;
    }
    .form-textarea:focus { border-color: var(--accent); }
    .form-textarea::placeholder { color: var(--text-muted); }
    .form-hint { font-size: 10px; color: var(--text-muted); margin-top: 4px; }
    
    /* Export options */
    .export-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
    .export-option {
      display: flex; align-items: center; gap: 10px;
      padding: 12px 14px; background: rgba(255,255,255,0.03);
      border: 1px solid var(--glass-border); border-radius: 12px;
      cursor: pointer; transition: all 0.15s;
    }
    .export-option:hover { background: rgba(255,255,255,0.06); border-color: var(--accent); }
    .export-option-icon { font-size: 18px; }
    .export-option-info { flex: 1; }
    .export-option-title { font-size: 13px; font-weight: 500; }
    .export-option-desc { font-size: 11px; color: var(--text-muted); }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

    /* Daily Quote - minimal text line */
    .daily-quote {
      display: flex; align-items: center; gap: 6px;
      margin: 0 0 8px 0; padding: 0;
      background: none !important; border: none !important;
    }
    .daily-quote .quote-text { 
      font-size: 11px; font-style: italic; color: var(--text-muted); 
      flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
      opacity: 0.6;
    }
    .quote-actions { display: flex; gap: 2px; opacity: 0; transition: opacity 0.2s; }
    .daily-quote:hover .quote-actions { opacity: 0.5; }
    .quote-btn {
      width: 16px; height: 16px; border-radius: 3px;
      background: transparent; border: none; color: var(--text-muted);
      cursor: pointer; font-size: 10px; transition: all 0.2s;
    }
    .quote-btn:hover { color: var(--text-primary); }

    /* Dictionary enhancement for vocab */
    .vocab-dict-btn { font-size: 11px; color: var(--accent); cursor: pointer; margin-left: 8px; }
    .vocab-dict-btn:hover { text-decoration: underline; }
    .dict-result { font-size: 11px; color: var(--text-muted); margin-top: 4px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; }
    .dict-phonetics { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 4px; }
    .dict-phonetic { cursor: pointer; color: var(--accent); }
    .dict-phonetic:hover { text-decoration: underline; }
    .dict-meanings { max-height: 100px; overflow-y: auto; }
    .dict-meaning { margin-bottom: 4px; }
    .dict-pos { font-weight: 600; color: var(--text-secondary); margin-right: 4px; }
  </style>
</head>
<body>
  <div class="bg-layer"></div>
  <div class="bg-image" id="bgImage"></div>
  <div class="bg-overlay"></div>

  <div class="container">
    <header class="header">
      <div class="header-left">
        <div class="header-time">
          <h1 class="clock" id="clock">12:00</h1>
          <div class="time-info">
            <span class="greeting" id="greeting">‰∏ãÂçàÂ•Ω</span>
            <span class="date" id="dateDisplay">2024Âπ¥1Êúà1Êó• ÊòüÊúü‰∏Ä</span>
          </div>
        </div>
        <!-- Weather in header -->
        <div class="header-weather" id="headerWeather">
          <span class="hw-icon">üå°Ô∏è</span>
          <span class="hw-temp">--¬∞</span>
          <span class="hw-desc">Âä†ËΩΩ‰∏≠</span>
        </div>
      </div>
      <div class="header-right">
        <div class="search-box">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
          </svg>
          <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢..." autocomplete="off">
        </div>
        <div class="header-actions">
          <button class="icon-btn" id="settingsBtn" title="ËÆæÁΩÆ">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
          <button class="icon-btn" id="themeToggle" title="‰∏ªÈ¢ò">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <!-- Daily Quote under header -->
    <div class="daily-quote" id="dailyQuote">
      <span id="quoteContent" class="quote-text">"Âä†ËΩΩ‰∏≠..."</span>
      <span class="quote-actions">
        <button class="quote-btn" id="toggleQuoteType" title="ÂàáÊç¢">‚Üª</button>
      </span>
    </div>

    <nav class="quick-links" id="quickLinks"></nav>

    <main class="dashboard">
      <section class="card">
        <div class="card-header">
          <span class="card-title">ÂÄíËÆ°Êó∂</span>
          <button class="card-action" id="addCountdownBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
          </button>
        </div>
        <div class="countdown-list" id="countdownList"></div>
      </section>

      <section class="card vocab-card">
        <div class="card-header">
          <span class="card-title">ÂçïËØçÂ≠¶‰π†</span>
          <div class="vocab-header-actions">
            <button class="card-action" id="fetchRandomWordBtn" title="ÈöèÊú∫Êñ∞ËØç">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
            </button>
            <button class="card-action" id="manageVocabBtn" title="ÁÆ°ÁêÜËØçÂ∫ì">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v18M3 9l9-6 9 6M3 15l9 6 9-6"/></svg>
            </button>
          </div>
        </div>
        
        <!-- Top bar with streak and XP -->
        <div class="vocab-top-bar">
          <div class="vocab-streak-badge">
            <span class="fire">üî•</span>
            <span class="count" id="vocabStreak">0</span>
            <span>Â§©</span>
          </div>
          <div class="vocab-xp-badge">
            <span>‚ú®</span>
            <span id="vocabTodayCount">0</span>
            <span>/ ‰ªäÊó•</span>
          </div>
        </div>
        
        <!-- Progress bar -->
        <div class="vocab-progress-bar">
          <div class="vocab-progress-fill" id="vocabProgressFill" style="width: 0%"></div>
        </div>
        
        <!-- Main flashcard -->
        <div class="vocab-flashcard" id="vocabFlashcard">
          <!-- Mastery dots -->
          <div class="vocab-mastery" id="vocabMastery">
            <div class="vocab-mastery-dot"></div>
            <div class="vocab-mastery-dot"></div>
            <div class="vocab-mastery-dot"></div>
            <div class="vocab-mastery-dot"></div>
            <div class="vocab-mastery-dot"></div>
          </div>
          
          <!-- Card counter -->
          <div class="vocab-counter" id="vocabCounter">1 / 10</div>
          
          <!-- Word content -->
          <div class="vocab-word" id="vocabWord">-</div>
          <div class="vocab-phonetic" id="vocabPhonetic">
            <span class="sound-icon">üîä</span>
            <span class="text"></span>
          </div>
          
          <div class="vocab-divider" id="vocabDivider"></div>
          
          <div class="vocab-meaning" id="vocabMeaning">ÁÇπÂáªÂç°ÁâáÊòæÁ§∫Èáä‰πâ</div>
          
          <div class="vocab-extra" id="vocabExtra">
            <div class="vocab-example" id="vocabExample"></div>
            <div class="vocab-synonyms" id="vocabSynonyms"></div>
          </div>
          
          <!-- Tap hint -->
          <div class="vocab-tap-hint" id="vocabTapHint">
            <span>üëÜ</span>
            <span>ÁÇπÂáªÊòæÁ§∫Á≠îÊ°à</span>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="vocab-actions" id="vocabActions"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <span class="card-title">ÂæÖÂäû</span>
          <button class="card-action" id="archiveTodosBtn" title="ÂΩíÊ°£">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8v13H3V8M1 3h22v5H1zM10 12h4"/></svg>
          </button>
        </div>
        <div class="todo-tabs">
          <button class="todo-tab active" data-tab="today">‰ªäÊó•</button>
          <button class="todo-tab" data-tab="week">Êú¨Âë®</button>
          <button class="todo-tab" data-tab="later">Á®çÂêé</button>
        </div>
        <div class="todo-input-row">
          <input type="text" class="todo-input" id="todoInput" placeholder="Êñ∞‰ªªÂä°...">
          <button class="todo-add-btn" id="addTodoBtn">+</button>
        </div>
        <div class="todo-list" id="todoList"></div>
      </section>
    </main>

    <footer class="footer" style="display:none">
      <input type="file" id="importFileInputOld" accept=".json" style="display:none">
    </footer>
  </div>

  <!-- Link Modal -->
  <div class="modal-overlay" id="linkModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Ê∑ªÂä†ÈìæÊé•</h3>
        <button class="modal-close" id="closeLinkModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="form-group"><label class="form-label">ÂêçÁß∞</label><input type="text" class="form-input" id="linkName" placeholder="ÁΩëÁ´ôÂêçÁß∞"></div>
      <div class="form-group"><label class="form-label">URL</label><input type="url" class="form-input" id="linkUrl" placeholder="https://..."></div>
      <div class="form-group"><label class="form-label">Âø´Êç∑ÈîÆ</label><input type="text" class="form-input" id="linkKey" placeholder="ÂçïÂ≠óÊØç" maxlength="1"></div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelLinkBtn">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="saveLinkBtn">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Countdown Modal -->
  <div class="modal-overlay" id="countdownModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Ê∑ªÂä†ÂÄíËÆ°Êó∂</h3>
        <button class="modal-close" id="closeCountdownModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="form-group"><label class="form-label">ÂêçÁß∞</label><input type="text" class="form-input" id="countdownName" placeholder="‰∫ã‰ª∂ÂêçÁß∞"></div>
      <div class="form-group"><label class="form-label">Êó•Êúü</label><input type="date" class="form-input" id="countdownDate"></div>
      <div class="form-group"><label class="form-label" style="display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" id="countdownRepeat" style="width:16px;height:16px"> ÊØèÂπ¥ÈáçÂ§ç</label></div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelCountdownBtn">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="saveCountdownBtn">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Vocab Modal -->
  <div class="modal-overlay" id="vocabModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ÁÆ°ÁêÜËØçÂ∫ì</h3>
        <button class="modal-close" id="closeVocabModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="form-group"><label class="form-label">Ê∑ªÂä†ÂçïËØçÔºàÊØèË°åÔºöÂçïËØç | Èü≥Ê†á | Èáä‰πâÔºâ</label><textarea class="form-input" id="vocabInput" rows="5" placeholder="word | /phonetic/ | meaning"></textarea></div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelVocabBtn">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="saveVocabBtn">‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Batch Link Modal -->
  <div class="modal-overlay" id="batchLinkModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ÊâπÈáèÊ∑ªÂä†ÈìæÊé•</h3>
        <button class="modal-close" id="closeBatchLinkModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="form-group">
        <label class="form-label">ÈìæÊé•ÂàóË°®</label>
        <textarea class="form-textarea" id="batchLinkInput" placeholder="GitHub | https://github.com | g&#10;Google | https://google.com | s&#10;Twitter | https://twitter.com"></textarea>
        <p class="form-hint">ÊØèË°å‰∏Ä‰∏™ÈìæÊé•ÔºåÊ†ºÂºèÔºöÂêçÁß∞ | URL | Âø´Êç∑ÈîÆÔºàÂèØÈÄâÔºâ</p>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" id="cancelBatchLinkBtn">ÂèñÊ∂à</button>
        <button class="btn btn-primary" id="saveBatchLinkBtn">ÂØºÂÖ•</button>
      </div>
    </div>
  </div>

  <!-- Export Modal -->
  <div class="modal-overlay" id="exportModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ÂØºÂá∫Êï∞ÊçÆ</h3>
        <button class="modal-close" id="closeExportModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="export-options">
        <div class="export-option" id="exportAll">
          <span class="export-option-icon">üì¶</span>
          <div class="export-option-info">
            <div class="export-option-title">ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ</div>
            <div class="export-option-desc">ÂåÖÂê´ÈìæÊé•„ÄÅÂÄíËÆ°Êó∂„ÄÅÂæÖÂäû„ÄÅËØçÂ∫ìÂíåËÆæÁΩÆ</div>
          </div>
        </div>
        <div class="export-option" id="exportLinks">
          <span class="export-option-icon">üîó</span>
          <div class="export-option-info">
            <div class="export-option-title">‰ªÖÂØºÂá∫ÈìæÊé•</div>
            <div class="export-option-desc">Á∫ØÊñáÊú¨Ê†ºÂºèÔºåÊñπ‰æøÂàÜ‰∫´</div>
          </div>
        </div>
        <div class="export-option" id="exportVocab">
          <span class="export-option-icon">üìö</span>
          <div class="export-option-info">
            <div class="export-option-title">‰ªÖÂØºÂá∫ËØçÂ∫ì</div>
            <div class="export-option-desc">ÂåÖÂê´Â≠¶‰π†ËøõÂ∫¶ÁöÑËØçÂ∫ìÊï∞ÊçÆ</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal-overlay" id="settingsModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ËÆæÁΩÆ</h3>
        <button class="modal-close" id="closeSettingsModal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
      </div>
      <div class="form-group">
        <label class="form-label">ÊöóËâ≤ËÉåÊôØ</label>
        <div class="bg-selector" id="bgSelector">
          <div class="bg-option gradient-1 active" data-bg="gradient-1" title="Ê∑±ÈÇÉÂ§úÁ©∫"></div>
          <div class="bg-option gradient-2" data-bg="gradient-2" title="Á•ûÁßòÁ¥´Â§ú"></div>
          <div class="bg-option gradient-3" data-bg="gradient-3" title="Ê∑±Êµ∑Ëìù"></div>
          <div class="bg-option gradient-4" data-bg="gradient-4" title="ÊöóÂ§úÊ£ÆÊûó"></div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">‰∫ÆËâ≤ËÉåÊôØ</label>
        <div class="bg-selector">
          <div class="bg-option light-1" data-bg="light-1" title="ÂÜ∑ÁÅ∞"></div>
          <div class="bg-option light-2" data-bg="light-2" title="ÊöñÁ±≥"></div>
          <div class="bg-option light-3" data-bg="light-3" title="ÈõæËìù"></div>
          <div class="bg-option light-4" data-bg="light-4" title="Â•∂Ëå∂"></div>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Ëá™ÂÆö‰πâËÉåÊôØURL</label><input type="url" class="form-input" id="customBgUrl" placeholder="https://..."></div>
      <div class="settings-section">
        <div class="settings-section-title">Êï∞ÊçÆÁÆ°ÁêÜ</div>
        <div class="settings-actions">
          <button class="settings-action-btn" id="exportDataBtn"><span class="settings-action-icon">üì¶</span>ÂØºÂá∫ÂÖ®ÈÉ®Êï∞ÊçÆ</button>
          <button class="settings-action-btn" id="importDataBtn"><span class="settings-action-icon">üì•</span>ÂØºÂÖ•Êï∞ÊçÆ</button>
          <button class="settings-action-btn danger" id="clearDataBtn"><span class="settings-action-icon">üóëÔ∏è</span>Ê∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®</button>
        </div>
      </div>
      <input type="file" id="importFileInput" accept=".json" style="display:none">
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'startpage_data';
    const defaultData = {
      theme: 'dark', background: 'gradient-1', customBg: '',
      links: [
        // AI Assistants
        { name: 'ChatGPT', url: 'https://chat.openai.com', key: 'c' },
        { name: 'Claude', url: 'https://claude.ai', key: 'a' },
        { name: 'Gemini', url: 'https://gemini.google.com', key: 'e' },
        { name: 'Perplexity', url: 'https://perplexity.ai', key: 'p' },
        { name: 'Poe', url: 'https://poe.com', key: '' },
        // AI Tools
        { name: 'Midjourney', url: 'https://midjourney.com', key: 'm' },
        { name: 'Runway', url: 'https://runwayml.com', key: '' },
        { name: 'ElevenLabs', url: 'https://elevenlabs.io', key: '' },
        { name: 'Hugging Face', url: 'https://huggingface.co', key: 'h' },
        // Dev
        { name: 'GitHub', url: 'https://github.com', key: 'g' },
        { name: 'Vercel', url: 'https://vercel.com', key: 'v' },
        { name: 'Cursor', url: 'https://cursor.com', key: '' },
        // Search & Social
        { name: 'Google', url: 'https://google.com', key: 's' },
        { name: 'X', url: 'https://x.com', key: 'x' },
        { name: 'YouTube', url: 'https://youtube.com', key: 'y' },
        { name: 'Reddit', url: 'https://reddit.com', key: 'r' }
      ],
      countdowns: [
        { name: 'ÂÖÉÊó¶', date: '2026-01-01' },
        { name: 'Êò•ËäÇ', date: '2026-02-17' },
        { name: 'Ê∏ÖÊòéËäÇ', date: '2026-04-05' },
        { name: 'Âä≥Âä®ËäÇ', date: '2026-05-01' },
        { name: 'Á´ØÂçàËäÇ', date: '2026-06-19' },
        { name: '‰∏≠ÁßãËäÇ', date: '2026-09-27' },
        { name: 'ÂõΩÂ∫ÜËäÇ', date: '2026-10-01' }
      ],
      todos: {
        today: [
          { text: 'ÈòÖËØª Anthropic ÊäÄÊúØÂçöÂÆ¢', completed: false },
          { text: 'ÊµãËØï Claude API Êñ∞ÂäüËÉΩ', completed: false },
          { text: 'Êï¥ÁêÜ AI Â∑•ÂÖ∑Êî∂ËóèÂ§π', completed: true }
        ],
        week: [
          { text: 'Â≠¶‰π† LangChain Ê°ÜÊû∂', completed: false },
          { text: 'Êê≠Âª∫Êú¨Âú∞ LLM ÁéØÂ¢É', completed: false }
        ],
        later: [
          { text: 'Á†îÁ©∂ RAG ÊúÄ‰Ω≥ÂÆûË∑µ', completed: false },
          { text: 'ÂÜô‰∏ÄÁØá AI Â∑•ÂÖ∑ÂØπÊØîÊñáÁ´†', completed: false }
        ]
      },
      vocab: {
        words: [
          { word: 'hallucination', phonetic: '/h…ôÀåluÀês…™Ààne…™ Én/', meaning: 'AI ÂπªËßâÔºåÁîüÊàêËôöÂÅá‰ø°ÊÅØ', interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null },
          { word: 'emergent', phonetic: '/…™Ààm…úÀêd í…ônt/', meaning: 'Ê∂åÁé∞ÁöÑÔºàËÉΩÂäõÔºâ', interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null },
          { word: 'fine-tuning', phonetic: '/fa…™n ÀàtjuÀên…™≈ã/', meaning: 'ÂæÆË∞ÉÔºåÁ≤æË∞ÉÊ®°Âûã', interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null },
          { word: 'inference', phonetic: '/Àà…™nf…ôr…ôns/', meaning: 'Êé®ÁêÜÔºåÊ®°ÂûãÊé®Êñ≠', interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null },
          { word: 'tokenization', phonetic: '/Àåto äk…ôna…™Ààze…™ Én/', meaning: 'ÂàÜËØçÔºåÊ†áËÆ∞Âåñ', interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null },
          { word: 'embedding', phonetic: '/…™mÀàbed…™≈ã/', meaning: 'ÂµåÂÖ•ÔºåÂêëÈáèË°®Á§∫', interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null }
        ],
        dailyNew: 5, todayLearned: [], streak: 0, lastStudyDate: null, totalWordsLearned: 0
      }
    };
    let data = loadData();
    function loadData() {
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        const merged = { ...defaultData, ...saved };
        // Deep merge nested objects
        merged.todos = { ...defaultData.todos, ...(saved.todos || {}) };
        merged.vocab = { ...defaultData.vocab, ...(saved.vocab || {}) };
        return merged;
      } catch { return JSON.parse(JSON.stringify(defaultData)); }
    }
    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      } catch (e) {
        console.error('Failed to save data:', e);
        alert('‰øùÂ≠òÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÂ≠òÂÇ®Á©∫Èó¥Â∑≤Êª°');
      }
    }
    function el(id) { return document.getElementById(id); }
    function ce(tag, cls, txt) { const e = document.createElement(tag); if (cls) e.className = cls; if (txt) e.textContent = txt; return e; }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    // Unified fetch with timeout
    async function fetchWithTimeout(url, options = {}, timeout = 8000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeout);
      try {
        const response = await fetch(url, { ...options, signal: controller.signal });
        clearTimeout(id);
        return response;
      } catch (error) {
        clearTimeout(id);
        throw error;
      }
    }
    function svg(d, w=14, h=14) {
      const s = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      s.setAttribute('width', w); s.setAttribute('height', h); s.setAttribute('viewBox', '0 0 24 24');
      s.setAttribute('fill', 'none'); s.setAttribute('stroke', 'currentColor'); s.setAttribute('stroke-width', '2');
      const p = document.createElementNS('http://www.w3.org/2000/svg', 'path'); p.setAttribute('d', d); s.appendChild(p); return s;
    }

    // Clock
    function updateClock() {
      const now = new Date(), h = now.getHours(), m = String(now.getMinutes()).padStart(2, '0');
      el('clock').textContent = h + ':' + m;
      el('greeting').textContent = h < 12 ? 'Êó©‰∏äÂ•Ω' : h < 18 ? '‰∏ãÂçàÂ•Ω' : 'Êôö‰∏äÂ•Ω';
      el('dateDisplay').textContent = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
    }

    // Theme
    function initTheme() {
      document.documentElement.setAttribute('data-theme', data.theme || 'dark');
      el('themeIcon').innerHTML = data.theme === 'light' ? '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>' : '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
    }
    function toggleTheme() {
      data.theme = data.theme === 'dark' ? 'light' : 'dark';
      // Auto switch background to match theme
      if (data.theme === 'light' && data.background && data.background.startsWith('gradient-')) {
        data.background = 'light-1';
      } else if (data.theme === 'dark' && data.background && data.background.startsWith('light-')) {
        data.background = 'gradient-1';
      }
      saveData(); initTheme(); initBg();
    }

    // Background
    function initBg() {
      const layer = document.querySelector('.bg-layer'), img = el('bgImage');
      if (data.customBg) { img.style.backgroundImage = 'url(' + data.customBg + ')'; img.classList.add('loaded'); }
      else {
        const g = {
          'gradient-1': '#111827',
          'gradient-2': '#1e1b4b',
          'gradient-3': '#0c4a6e',
          'gradient-4': '#14532d',
          'light-1': '#fffbf5',
          'light-2': '#fff',
          'light-3': '#f8fafc',
          'light-4': '#fef7f7'
        };
        // Auto-correct background if theme doesn't match
        const isLightTheme = data.theme === 'light';
        const isLightBg = data.background && data.background.startsWith('light-');
        if (isLightTheme && !isLightBg) {
          data.background = 'light-1';
          saveData();
        } else if (!isLightTheme && isLightBg) {
          data.background = 'gradient-1';
          saveData();
        }
        layer.style.background = g[data.background] || (isLightTheme ? g['light-1'] : g['gradient-1']);
      }
      document.querySelectorAll('.bg-option').forEach(o => o.classList.toggle('active', o.dataset.bg === data.background));
    }

    // Quick Links
    // Drag state for links
    let draggedLinkIdx = null;
    
    function renderLinks(filter = '') {
      const c = el('quickLinks'); c.replaceChildren();
      data.links.filter(l => !filter || l.name.toLowerCase().includes(filter.toLowerCase())).forEach((link, idx) => {
        const a = ce('a', 'quick-link'); a.href = link.url; a.target = '_blank'; a.dataset.key = link.key || '';
        a.draggable = true;
        a.dataset.idx = data.links.indexOf(link);
        // Drag events
        a.ondragstart = (e) => { draggedLinkIdx = parseInt(a.dataset.idx); a.classList.add('dragging'); };
        a.ondragend = () => { a.classList.remove('dragging'); draggedLinkIdx = null; };
        a.ondragover = (e) => { e.preventDefault(); a.classList.add('drag-over'); };
        a.ondragleave = () => { a.classList.remove('drag-over'); };
        a.ondrop = (e) => {
          e.preventDefault(); a.classList.remove('drag-over');
          const toIdx = parseInt(a.dataset.idx);
          if (draggedLinkIdx !== null && draggedLinkIdx !== toIdx) {
            const [moved] = data.links.splice(draggedLinkIdx, 1);
            data.links.splice(toIdx, 0, moved);
            saveData(); renderLinks(filter);
          }
        };
        const img = document.createElement('img');
        try { img.src = 'https://www.google.com/s2/favicons?domain=' + new URL(link.url).hostname + '&sz=32'; } catch {}
        a.appendChild(img); a.appendChild(ce('span', '', link.name));
        if (link.key) a.appendChild(ce('span', 'key', link.key));
        c.appendChild(a);
      });
      const addBtn = ce('button', 'add-link-btn'); addBtn.innerHTML = '+'; addBtn.onclick = () => openModal('linkModal'); c.appendChild(addBtn);
      const batchBtn = ce('button', 'batch-link-btn', 'ÊâπÈáè'); batchBtn.onclick = () => openModal('batchLinkModal'); c.appendChild(batchBtn);
    }
    function addLink() {
      const name = el('linkName').value.trim(), url = el('linkUrl').value.trim(), key = el('linkKey').value.trim().toLowerCase();
      if (!name || !url) return alert('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåURL');
      // Validate URL format
      try {
        new URL(url.startsWith('http') ? url : 'https://' + url);
      } catch (e) {
        return alert('URL Ê†ºÂºè‰∏çÊ≠£Á°Æ');
      }
      // Validate shortcut key (single letter or empty)
      if (key && !/^[a-z]$/.test(key)) return alert('Âø´Êç∑ÈîÆÂøÖÈ°ªÊòØÂçï‰∏™Â≠óÊØç');
      // Check for duplicate shortcut key
      if (key && data.links.some(l => l.key === key)) return alert('Âø´Êç∑ÈîÆÂ∑≤Ë¢´‰ΩøÁî®');
      const finalUrl = url.startsWith('http') ? url : 'https://' + url;
      data.links.push({ name, url: finalUrl, key }); saveData(); renderLinks(); closeModal('linkModal');
      ['linkName', 'linkUrl', 'linkKey'].forEach(id => el(id).value = '');
    }

    // Countdown
    function getNextOccurrence(dateStr, repeat) {
      if (!repeat) return new Date(dateStr);
      const date = new Date(dateStr);
      const now = new Date();
      const thisYear = new Date(now.getFullYear(), date.getMonth(), date.getDate());
      const nextYear = new Date(now.getFullYear() + 1, date.getMonth(), date.getDate());
      return thisYear >= now ? thisYear : nextYear;
    }
    
    function renderCountdowns() {
      const c = el('countdownList'); c.replaceChildren(); const now = new Date();
      if (!data.countdowns.length) { c.appendChild(ce('div', 'empty-state', 'ÊöÇÊó†')); return; }
      const sorted = [...data.countdowns].map(item => ({
        ...item,
        nextDate: getNextOccurrence(item.date, item.repeat)
      })).sort((a, b) => a.nextDate - b.nextDate);
      
      sorted.forEach(item => {
        const idx = data.countdowns.findIndex(c => c.name === item.name && c.date === item.date);
        const diff = Math.ceil((item.nextDate - now) / 864e5);
        const d = ce('div', 'countdown-item' + (diff <= 3 ? ' urgent' : diff <= 7 ? ' soon' : ''));
        const info = ce('div', 'countdown-info');
        const nameEl = ce('div', 'countdown-name', item.name);
        if (item.repeat) nameEl.innerHTML += ' <span style="font-size:10px;opacity:0.6">üîÅ</span>';
        info.appendChild(nameEl);
        info.appendChild(ce('div', 'countdown-date', item.nextDate.toLocaleDateString('zh-CN')));
        const time = ce('div', 'countdown-time'); time.appendChild(ce('div', 'countdown-days', diff > 0 ? diff : '‰ªäÂ§©')); time.appendChild(ce('div', 'countdown-label', diff > 0 ? 'Â§©' : ''));
        const del = ce('button', 'card-action countdown-delete'); del.appendChild(svg('M18 6L6 18M6 6l12 12')); del.onclick = () => { data.countdowns.splice(idx, 1); saveData(); renderCountdowns(); };
        d.appendChild(info); d.appendChild(time); d.appendChild(del); c.appendChild(d);
      });
    }
    function addCountdown() {
      const name = el('countdownName').value.trim(), date = el('countdownDate').value;
      const repeat = el('countdownRepeat').checked;
      if (!name || !date) return alert('ËØ∑Â°´ÂÜôÂêçÁß∞ÂíåÊó•Êúü');
      // Validate date format
      const dateObj = new Date(date);
      if (isNaN(dateObj.getTime())) return alert('Êó•ÊúüÊ†ºÂºè‰∏çÊ≠£Á°Æ');
      data.countdowns.push({ name, date, repeat }); saveData(); renderCountdowns(); closeModal('countdownModal');
      el('countdownName').value = ''; el('countdownDate').value = ''; el('countdownRepeat').checked = false;
    }

    // Todo
    let curTab = 'today';
    let draggedTodoIdx = null;
    let draggedFromTab = null;
    
    function renderTodos() {
      const c = el('todoList'); c.replaceChildren(); const todos = data.todos[curTab] || [];
      if (!todos.length) { c.appendChild(ce('div', 'empty-state', 'ÊöÇÊó†')); return; }
      todos.forEach((t, i) => {
        const d = ce('div', 'todo-item' + (t.completed ? ' completed' : ''));
        d.draggable = true;
        d.dataset.idx = i;
        // Drag events for reordering and moving between tabs
        d.ondragstart = () => { draggedTodoIdx = i; draggedFromTab = curTab; d.classList.add('dragging'); };
        d.ondragend = () => { d.classList.remove('dragging'); draggedTodoIdx = null; draggedFromTab = null; };
        d.ondragover = (e) => { e.preventDefault(); d.classList.add('drag-over'); };
        d.ondragleave = () => { d.classList.remove('drag-over'); };
        d.ondrop = (e) => {
          e.preventDefault(); d.classList.remove('drag-over');
          const toIdx = parseInt(d.dataset.idx);
          if (draggedTodoIdx !== null && draggedFromTab === curTab && draggedTodoIdx !== toIdx) {
            const [moved] = data.todos[curTab].splice(draggedTodoIdx, 1);
            data.todos[curTab].splice(toIdx, 0, moved);
            saveData(); renderTodos();
          }
        };
        const cb = ce('div', 'todo-checkbox' + (t.completed ? ' checked' : '')); cb.onclick = () => { data.todos[curTab][i].completed = !t.completed; saveData(); renderTodos(); };
        const txt = ce('span', 'todo-text', t.text);
        const act = ce('div', 'todo-actions'); const del = ce('button', 'todo-action-btn'); del.appendChild(svg('M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2'));
        del.onclick = () => { data.todos[curTab].splice(i, 1); saveData(); renderTodos(); }; act.appendChild(del);
        d.appendChild(cb); d.appendChild(txt); d.appendChild(act); c.appendChild(d);
      });
    }
    function addTodo() {
      const txt = el('todoInput').value.trim();
      if (!txt) return;
      if (!data.todos[curTab]) data.todos[curTab] = []; // Safety check
      data.todos[curTab].unshift({ text: txt, completed: false });
      saveData(); renderTodos(); el('todoInput').value = '';
    }
    function switchTab(t) {
      curTab = t;
      document.querySelectorAll('.todo-tab').forEach(e => {
        e.classList.toggle('active', e.dataset.tab === t);
        // Add drop target for moving todos between tabs
        e.ondragover = (ev) => { ev.preventDefault(); e.classList.add('drag-over'); };
        e.ondragleave = () => { e.classList.remove('drag-over'); };
        e.ondrop = (ev) => {
          ev.preventDefault(); e.classList.remove('drag-over');
          const targetTab = e.dataset.tab;
          if (draggedTodoIdx !== null && draggedFromTab && targetTab !== draggedFromTab) {
            const [moved] = data.todos[draggedFromTab].splice(draggedTodoIdx, 1);
            if (!data.todos[targetTab]) data.todos[targetTab] = [];
            data.todos[targetTab].unshift(moved);
            saveData();
            if (curTab === draggedFromTab || curTab === targetTab) renderTodos();
          }
        };
      });
      renderTodos();
    }
    function archiveTodos() { Object.keys(data.todos).forEach(t => data.todos[t] = data.todos[t].filter(x => !x.completed)); saveData(); renderTodos(); }

    // Vocab
    let wordIdx = 0, showMeaning = false, words = [], currentWordData = null, totalCards = 0, currentCard = 0;
    function getReview() { return data.vocab.words.filter(w => !w.nextReview || new Date(w.nextReview) <= new Date()); }
    function getNew() {
      const today = new Date().toDateString();
      if (data.vocab.todayDate !== today) { data.vocab.todayDate = today; data.vocab.todayLearned = []; saveData(); }
      return data.vocab.words.filter(w => !w.nextReview && !data.vocab.todayLearned.includes(w.word)).slice(0, data.vocab.dailyNew - data.vocab.todayLearned.length);
    }
    function updateStats() { 
      el('vocabTodayCount').textContent = data.vocab.todayLearned ? data.vocab.todayLearned.length : 0;
      el('vocabStreak').textContent = data.vocab.streak || 0;
      // Update progress bar
      const total = data.vocab.words.length;
      const mastered = data.vocab.words.filter(w => w.repetition >= 5).length;
      const progress = total > 0 ? (mastered / total) * 100 : 0;
      el('vocabProgressFill').style.width = progress + '%';
    }
    function updateMasteryDots(repetition) {
      const dots = document.querySelectorAll('.vocab-mastery-dot');
      dots.forEach((dot, i) => {
        dot.classList.remove('filled', 'current');
        if (i < repetition) dot.classList.add('filled');
        else if (i === repetition) dot.classList.add('current');
      });
    }
    function updateStreak() {
      const today = new Date().toDateString();
      const lastDate = data.vocab.lastStudyDate;
      if (lastDate !== today) {
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
        if (lastDate === yesterday.toDateString()) {
          data.vocab.streak = (data.vocab.streak || 0) + 1;
        } else if (lastDate !== today) {
          data.vocab.streak = 1;
        }
        data.vocab.lastStudyDate = today;
        saveData();
      }
    }
    function vocabBtns(mode) {
      const c = el('vocabActions'); c.replaceChildren();
      if (mode === 'init') {
        const reveal = ce('button', 'vocab-btn-reveal', '');
        reveal.innerHTML = '<span>üëÄ</span><span>ÊòæÁ§∫Á≠îÊ°à</span>';
        reveal.onclick = toggleMean;
        c.appendChild(reveal);
      } else {
        const btns = [
          { cls: 'forgot', icon: 'üòï', text: 'Âøò‰∫Ü', q: 1 },
          { cls: 'hard', icon: 'ü§î', text: 'Ê®°Á≥ä', q: 3 },
          { cls: 'good', icon: 'üòä', text: 'ËÆ∞‰Ωè', q: 4 },
          { cls: 'easy', icon: 'üéØ', text: 'ÁÆÄÂçï', q: 5 }
        ];
        btns.forEach(b => {
          const btn = ce('button', 'vocab-btn ' + b.cls);
          btn.innerHTML = '<span class="icon">' + b.icon + '</span><span>' + b.text + '</span>';
          btn.onclick = () => rate(b.q);
          c.appendChild(btn);
        });
      }
    }
    function nextWord() {
      words = [...getReview(), ...getNew()];
      totalCards = words.length;
      
      // Clear previous data
      el('vocabExample').textContent = '';
      el('vocabSynonyms').innerHTML = '';
      el('vocabDivider').classList.remove('show');
      el('vocabExtra').classList.remove('show');
      el('vocabTapHint').classList.remove('hidden');
      currentWordData = null;
      
      if (!words.length) { 
        // Show complete state
        // Note: vocabCounter is inside vocabFlashcard, so we update it before replacing innerHTML
        const flashcard = el('vocabFlashcard');
        const counter = el('vocabCounter');
        if (counter) counter.textContent = 'ÂÆåÊàê';
        flashcard.innerHTML = '<div class="vocab-complete"><div class="vocab-complete-icon">üéâ</div><div class="vocab-complete-title">‰ªäÊó•ÂÆåÊàê!</div><div class="vocab-complete-text">ÊòéÂ§©ÁªßÁª≠‰øùÊåÅÂ≠¶‰π†Âì¶</div></div>';
        el('vocabActions').replaceChildren();
        return; 
      }
      
      wordIdx = Math.floor(Math.random() * words.length);
      currentCard++;
      const w = words[wordIdx]; 
      currentWordData = w;
      
      el('vocabWord').textContent = w.word; 
      const phoneticEl = el('vocabPhonetic');
      phoneticEl.querySelector('.text').textContent = w.phonetic || '';
      phoneticEl.style.display = w.phonetic ? 'inline-flex' : 'none';
      
      el('vocabMeaning').textContent = w.meaning; 
      el('vocabMeaning').classList.remove('show'); 
      showMeaning = false; 
      
      // Update counter
      el('vocabCounter').textContent = currentCard + ' / ' + (currentCard + words.length - 1);
      
      // Update mastery dots
      updateMasteryDots(w.repetition || 0);
      
      vocabBtns('init');
      
      // Fetch synonyms in background
      fetchSynonyms(w.word);
    }
    function toggleMean() { 
      showMeaning = !showMeaning; 
      el('vocabMeaning').classList.toggle('show', showMeaning); 
      el('vocabDivider').classList.toggle('show', showMeaning);
      el('vocabExtra').classList.toggle('show', showMeaning);
      el('vocabTapHint').classList.toggle('hidden', showMeaning);
      
      if (showMeaning) {
        vocabBtns('rate');
        // Fetch example sentence if not already fetched
        if (currentWordData && !el('vocabExample').textContent) {
          fetchExample(currentWordData.word);
        }
      }
    }
    function rate(q) {
      const w = words[wordIdx]; if (!w) return;
      updateStreak();
      if (q < 3) { w.repetition = 0; w.interval = 1; } 
      else { 
        w.interval = w.repetition === 0 ? 1 : w.repetition === 1 ? 6 : Math.round(w.interval * w.easeFactor); 
        w.repetition++; 
      }
      w.easeFactor = Math.max(1.3, w.easeFactor + (0.1 - (5-q)*(0.08+(5-q)*0.02)));
      const nr = new Date(); nr.setDate(nr.getDate() + w.interval); w.nextReview = nr.toISOString();
      if (!data.vocab.todayLearned.includes(w.word)) {
        data.vocab.todayLearned.push(w.word);
        data.vocab.totalWordsLearned = (data.vocab.totalWordsLearned || 0) + 1;
      }
      saveData(); updateStats(); nextWord();
    }
    function addVocab() {
      const input = el('vocabInput').value.trim(); if (!input) return;
      input.split('\n').filter(l => l.trim()).forEach(line => {
        const p = line.split('|').map(x => x.trim());
        if (p.length >= 2 && !data.vocab.words.find(w => w.word === p[0])) data.vocab.words.push({ word: p[0], phonetic: p[1] || '', meaning: p[2] || p[1], interval: 1, repetition: 0, easeFactor: 2.5, nextReview: null });
      });
      saveData(); updateStats(); nextWord(); closeModal('vocabModal'); el('vocabInput').value = '';
    }
    
    // Datamuse API - fetch synonyms
    async function fetchSynonyms(word) {
      try {
        const res = await fetch('https://api.datamuse.com/words?rel_syn=' + encodeURIComponent(word) + '&max=5');
        if (!res.ok) return;
        const synonyms = await res.json();
        if (synonyms.length > 0) {
          const container = el('vocabSynonyms');
          container.innerHTML = '';
          synonyms.forEach(s => {
            const span = ce('span', '', s.word);
            container.appendChild(span);
          });
        }
      } catch (err) {
        console.log('Synonyms fetch failed:', err);
      }
    }
    
    // Fetch example sentence from Free Dictionary API
    async function fetchExample(word) {
      try {
        const res = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(word));
        if (!res.ok) return;
        const data = await res.json();
        if (data[0] && data[0].meanings) {
          for (const meaning of data[0].meanings) {
            for (const def of meaning.definitions) {
              if (def.example) {
                el('vocabExample').textContent = '"' + def.example + '"';
                return;
              }
            }
          }
        }
      } catch (err) {
        console.log('Example fetch failed:', err);
      }
    }
    
    // Random Word API - fetch new random words
    async function fetchRandomWord(retryCount = 0) {
      const MAX_RETRIES = 5;
      if (retryCount >= MAX_RETRIES) {
        alert('Â§öÊ¨°Â∞ùËØïÂêé‰ªçÊó†Ê≥ïËé∑ÂèñÊúâÊïàÂçïËØçÔºåËØ∑Á®çÂêéÈáçËØï');
        return;
      }
      
      const btn = el('fetchRandomWordBtn');
      btn.disabled = true;
      btn.style.opacity = '0.5';
      
      try {
        // Use Random Word API
        const res = await fetch('https://random-word-api.herokuapp.com/word?number=1');
        if (!res.ok) throw new Error('API error');
        const words = await res.json();
        const randomWord = words[0];
        
        // Now look up the definition
        const dictRes = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(randomWord));
        if (!dictRes.ok) {
          // Try another word if this one has no definition (with retry limit)
          return fetchRandomWord(retryCount + 1);
        }
        const dictData = await dictRes.json();
        const entry = dictData[0];
        
        // Extract info
        const phonetic = entry.phonetic || (entry.phonetics && entry.phonetics[0] ? entry.phonetics[0].text : '');
        let meaning = '';
        if (entry.meanings && entry.meanings[0] && entry.meanings[0].definitions && entry.meanings[0].definitions[0]) {
          meaning = entry.meanings[0].partOfSpeech + ': ' + entry.meanings[0].definitions[0].definition;
        }
        
        // Check if word already exists
        if (data.vocab.words.find(w => w.word.toLowerCase() === randomWord.toLowerCase())) {
          alert('ËØçÂ∫ì‰∏≠Â∑≤ÊúâÊ≠§ÂçïËØç: ' + randomWord);
          return;
        }
        
        // Add to vocab
        data.vocab.words.push({
          word: randomWord,
          phonetic: phonetic,
          meaning: meaning || 'No definition found',
          interval: 1,
          repetition: 0,
          easeFactor: 2.5,
          nextReview: null
        });
        saveData();
        updateStats();
        
        // Show the new word
        alert('Â∑≤Ê∑ªÂä†Êñ∞ÂçïËØç: ' + randomWord);
        nextWord();
        
      } catch (err) {
        console.error('Random word error:', err);
        alert('Ëé∑ÂèñÈöèÊú∫ÂçïËØçÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
      } finally {
        btn.disabled = false;
        btn.style.opacity = '1';
      }
    }

    // Modal
    function openModal(id) { el(id).classList.add('active'); }
    function closeModal(id) { el(id).classList.remove('active'); }

    // Settings
    function saveSett() { const bg = el('customBgUrl').value.trim(); if (bg) { data.customBg = bg; data.background = ''; } saveData(); initBg(); closeModal('settingsModal'); }
    function clearData() {
      if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÊú¨Âú∞Êï∞ÊçÆÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // Batch Links
    function addBatchLinks() {
      const input = el('batchLinkInput').value.trim(); if (!input) return;
      let added = 0;
      input.split('\n').filter(l => l.trim()).forEach(line => {
        const p = line.split('|').map(x => x.trim());
        if (p.length >= 2 && p[1].startsWith('http')) {
          const name = p[0], url = p[1], key = (p[2] || '').toLowerCase().slice(0, 1);
          if (!data.links.find(l => l.url === url)) { data.links.push({ name, url, key }); added++; }
        }
      });
      saveData(); renderLinks(); closeModal('batchLinkModal'); el('batchLinkInput').value = '';
      if (added > 0) alert('ÊàêÂäüÊ∑ªÂä† ' + added + ' ‰∏™ÈìæÊé•');
    }

    // Import/Export
    function exportAll() {
      const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        data: {
          theme: data.theme,
          background: data.background,
          customBg: data.customBg,
          links: data.links,
          countdowns: data.countdowns,
          todos: data.todos,
          vocab: data.vocab
        }
      };
      const b = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'}), u = URL.createObjectURL(b), a = document.createElement('a');
      a.href = u; a.download = 'startpage-backup-' + new Date().toISOString().slice(0,10) + '.json'; a.click(); URL.revokeObjectURL(u);
      closeModal('exportModal');
    }
    function exportLinks() {
      const txt = data.links.map(l => l.name + ' | ' + l.url + (l.key ? ' | ' + l.key : '')).join('\n');
      const b = new Blob([txt], {type:'text/plain'}), u = URL.createObjectURL(b), a = document.createElement('a');
      a.href = u; a.download = 'startpage-links.txt'; a.click(); URL.revokeObjectURL(u);
      closeModal('exportModal');
    }
    function exportVocab() {
      const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        vocab: data.vocab
      };
      const b = new Blob([JSON.stringify(exportData, null, 2)], {type:'application/json'}), u = URL.createObjectURL(b), a = document.createElement('a');
      a.href = u; a.download = 'startpage-vocab-' + new Date().toISOString().slice(0,10) + '.json'; a.click(); URL.revokeObjectURL(u);
      closeModal('exportModal');
    }
    function importD(f) {
      const r = new FileReader(); r.onload = e => {
        try {
          const imported = JSON.parse(e.target.result);
          // Handle new format with version
          if (imported.version && imported.data) {
            data = {...defaultData, ...imported.data};
          } else if (imported.version && imported.vocab) {
            // Vocab only import
            data.vocab = imported.vocab;
          } else {
            // Legacy format
            data = {...defaultData, ...imported};
          }
          saveData(); location.reload();
        } catch { alert('ÂØºÂÖ•Â§±Ë¥•ÔºöÊñá‰ª∂Ê†ºÂºèÈîôËØØ'); }
      }; r.readAsText(f);
    }

    // Keys
    document.addEventListener('keydown', e => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') { e.preventDefault(); el('searchInput').focus(); return; }
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.metaKey || e.ctrlKey || e.altKey) return; // Don't trigger shortcuts with modifier keys
      const link = document.querySelector('.quick-link[data-key="' + e.key.toLowerCase() + '"]');
      if (link) { e.preventDefault(); window.open(link.href, '_blank'); }
    });

    // Events
    el('themeToggle').onclick = toggleTheme;
    el('searchInput').oninput = e => renderLinks(e.target.value);
    el('saveLinkBtn').onclick = addLink;
    el('closeLinkModal').onclick = () => closeModal('linkModal');
    el('cancelLinkBtn').onclick = () => closeModal('linkModal');
    el('addCountdownBtn').onclick = () => openModal('countdownModal');
    el('saveCountdownBtn').onclick = addCountdown;
    el('closeCountdownModal').onclick = () => closeModal('countdownModal');
    el('cancelCountdownBtn').onclick = () => closeModal('countdownModal');
    document.querySelectorAll('.todo-tab').forEach(t => t.onclick = () => switchTab(t.dataset.tab));
    el('todoInput').onkeypress = e => { if (e.key === 'Enter') addTodo(); };
    el('addTodoBtn').onclick = addTodo;
    el('archiveTodosBtn').onclick = archiveTodos;
    el('manageVocabBtn').onclick = () => openModal('vocabModal');
    el('fetchRandomWordBtn').onclick = fetchRandomWord;
    el('vocabFlashcard').onclick = (e) => { if (!showMeaning && words.length && !e.target.closest('.vocab-phonetic')) toggleMean(); };
    el('vocabPhonetic').onclick = playPronunciation;
    el('saveVocabBtn').onclick = addVocab;
    el('closeVocabModal').onclick = () => closeModal('vocabModal');
    el('cancelVocabBtn').onclick = () => closeModal('vocabModal');
    el('settingsBtn').onclick = () => openModal('settingsModal');
    el('closeSettingsModal').onclick = () => closeModal('settingsModal');
    document.querySelectorAll('.bg-option').forEach(o => o.onclick = () => {
      document.querySelectorAll('.bg-option').forEach(x => x.classList.remove('active')); o.classList.add('active');
      data.background = o.dataset.bg; data.customBg = ''; el('customBgUrl').value = '';
      // Auto switch theme based on background
      const isLight = o.dataset.bg.startsWith('light-');
      if (isLight && data.theme !== 'light') { data.theme = 'light'; initTheme(); }
      else if (!isLight && data.theme !== 'dark') { data.theme = 'dark'; initTheme(); }
      saveData(); initBg();
    });
    el('exportDataBtn').onclick = () => openModal('exportModal');
    el('closeExportModal').onclick = () => closeModal('exportModal');
    el('exportAll').onclick = exportAll;
    el('exportLinks').onclick = exportLinks;
    el('exportVocab').onclick = exportVocab;
    el('closeBatchLinkModal').onclick = () => closeModal('batchLinkModal');
    el('cancelBatchLinkBtn').onclick = () => closeModal('batchLinkModal');
    el('saveBatchLinkBtn').onclick = addBatchLinks;
    el('importDataBtn').onclick = () => el('importFileInput').click();
    el('importFileInput').onchange = e => { if (e.target.files[0]) importD(e.target.files[0]); };
    el('clearDataBtn').onclick = clearData;
    document.querySelectorAll('.modal-overlay').forEach(o => o.onclick = e => { if (e.target === o) closeModal(o.id); });
    document.onkeydown = e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.active').forEach(m => closeModal(m.id)); };

    // Init
    initTheme(); initBg(); updateClock(); renderLinks(); renderCountdowns(); renderTodos(); updateStats(); nextWord();
    setInterval(updateClock, 1000); setInterval(renderCountdowns, 60000);

    // ========== API Features ==========

    // Weather API (wttr.in - free, no key needed)
    // WMO Weather codes for Open-Meteo
    const wmoWeatherCodes = {
      0: { icon: '‚òÄÔ∏è', desc: 'Êô¥' },
      1: { icon: 'üå§Ô∏è', desc: 'Â§ßÈÉ®Êô¥Êúó' },
      2: { icon: '‚õÖ', desc: 'Â§ö‰∫ë' },
      3: { icon: '‚òÅÔ∏è', desc: 'Èò¥' },
      45: { icon: 'üå´Ô∏è', desc: 'Èõæ' },
      48: { icon: 'üå´Ô∏è', desc: 'ÂÜªÈõæ' },
      51: { icon: 'üå¶Ô∏è', desc: 'Â∞èÊØõÊØõÈõ®' },
      53: { icon: 'üå¶Ô∏è', desc: 'ÊØõÊØõÈõ®' },
      55: { icon: 'üåßÔ∏è', desc: 'Â§ßÊØõÊØõÈõ®' },
      61: { icon: 'üåßÔ∏è', desc: 'Â∞èÈõ®' },
      63: { icon: 'üåßÔ∏è', desc: '‰∏≠Èõ®' },
      65: { icon: 'üåßÔ∏è', desc: 'Â§ßÈõ®' },
      66: { icon: 'üå®Ô∏è', desc: 'ÂÜªÂ∞èÈõ®' },
      67: { icon: 'üå®Ô∏è', desc: 'ÂÜªÂ§ßÈõ®' },
      71: { icon: 'üå®Ô∏è', desc: 'Â∞èÈõ™' },
      73: { icon: 'üå®Ô∏è', desc: '‰∏≠Èõ™' },
      75: { icon: '‚ùÑÔ∏è', desc: 'Â§ßÈõ™' },
      77: { icon: 'üå®Ô∏è', desc: 'Èõ™Á≤í' },
      80: { icon: 'üå¶Ô∏è', desc: 'Â∞èÈòµÈõ®' },
      81: { icon: 'üåßÔ∏è', desc: 'ÈòµÈõ®' },
      82: { icon: 'üåßÔ∏è', desc: 'Â§ßÈòµÈõ®' },
      85: { icon: 'üå®Ô∏è', desc: 'Â∞èÈòµÈõ™' },
      86: { icon: '‚ùÑÔ∏è', desc: 'Â§ßÈòµÈõ™' },
      95: { icon: '‚õàÔ∏è', desc: 'Èõ∑Êö¥' },
      96: { icon: '‚õàÔ∏è', desc: 'Èõ∑Êö¥‰º¥Â∞èÂÜ∞Èõπ' },
      99: { icon: '‚õàÔ∏è', desc: 'Èõ∑Êö¥‰º¥ÂÜ∞Èõπ' }
    };

    // Cache helper functions
    const CACHE_KEYS = {
      weather: 'cache_weather',
      quote: 'cache_quote',
      joke: 'cache_joke'
    };
    const CACHE_DURATION = {
      weather: 30 * 60 * 1000,  // 30 minutes
      quote: 60 * 60 * 1000,    // 1 hour
      joke: 60 * 60 * 1000      // 1 hour
    };
    
    function getCache(key) {
      try {
        const cached = localStorage.getItem(key);
        if (!cached) return null;
        const { data, timestamp } = JSON.parse(cached);
        const duration = CACHE_DURATION[key.replace('cache_', '')] || 30 * 60 * 1000;
        if (Date.now() - timestamp > duration) {
          localStorage.removeItem(key);
          return null;
        }
        return data;
      } catch { return null; }
    }
    
    function setCache(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify({ data, timestamp: Date.now() }));
      } catch (e) { console.log('Cache write failed:', e); }
    }

    async function fetchWeather(forceRefresh = false) {
      const hw = el('headerWeather');
      
      // Try cache first
      if (!forceRefresh) {
        const cached = getCache(CACHE_KEYS.weather);
        if (cached) {
          renderWeather(cached);
          return;
        }
      }
      
      hw.innerHTML = '<span class="hw-icon">üå°Ô∏è</span><span class="hw-desc">Ëé∑Âèñ‰∏≠...</span>';

      try {
        // Get user location
        const pos = await new Promise((resolve, reject) => {
          if (!navigator.geolocation) {
            reject(new Error('Geolocation not supported'));
            return;
          }
          navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
        });
        
        const { latitude, longitude } = pos.coords;
        
        // Fetch weather from Open-Meteo
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,apparent_temperature,weather_code,relative_humidity_2m,wind_speed_10m&timezone=auto`;
        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        
        // Get location name via reverse geocoding
        let locationName = `${latitude.toFixed(1)}, ${longitude.toFixed(1)}`;
        try {
          const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=zh`, { signal: AbortSignal.timeout(5000) });
          if (geoRes.ok) {
            const geo = await geoRes.json();
            locationName = geo.address?.city || geo.address?.town || geo.address?.county || locationName;
          }
        } catch {}
        
        const weatherData = { ...data, locationName };
        setCache(CACHE_KEYS.weather, weatherData);
        renderWeather(weatherData);
        
      } catch (err) {
        console.error('Weather error:', err);
        // Fallback: use default location (Shanghai)
        try {
          const url = 'https://api.open-meteo.com/v1/forecast?latitude=31.23&longitude=121.47&current=temperature_2m,apparent_temperature,weather_code,relative_humidity_2m,wind_speed_10m&timezone=auto';
          const res = await fetch(url);
          if (res.ok) {
            const data = await res.json();
            const weatherData = { ...data, locationName: '‰∏äÊµ∑' };
            setCache(CACHE_KEYS.weather, weatherData);
            renderWeather(weatherData);
            return;
          }
        } catch {}
        
        hw.innerHTML = '<span class="hw-icon">‚ùå</span><span class="hw-desc">Ëé∑ÂèñÂ§±Ë¥•</span>';
        hw.onclick = () => fetchWeather(true);
      }
    }
    
    function renderWeather(w) {
      const hw = el('headerWeather');
      const current = w.current;
      const weatherCode = current.weather_code;
      const weather = wmoWeatherCodes[weatherCode] || { icon: 'üå°Ô∏è', desc: 'Êú™Áü•' };
      
      hw.innerHTML = `
        <span class="hw-icon">${weather.icon}</span>
        <span class="hw-temp">${Math.round(current.temperature_2m)}¬∞</span>
        <span class="hw-desc">${weather.desc}</span>
        <span class="hw-location">üìç${w.locationName}</span>
      `;
      hw.title = `${w.locationName}\n‰ΩìÊÑü ${Math.round(current.apparent_temperature)}¬∞C\nÊπøÂ∫¶ ${current.relative_humidity_2m}%\nÈ£éÈÄü ${Math.round(current.wind_speed_10m)}km/h\nÁÇπÂáªÂà∑Êñ∞`;
      hw.onclick = () => fetchWeather(true);
    }

    // Quote API (Quotable - free, no key needed)
    async function fetchQuote(forceRefresh = false) {
      const content = el('quoteContent');
      const fallbackQuotes = [
        { content: 'The only way to do great work is to love what you do.', author: 'Steve Jobs' },
        { content: 'Innovation distinguishes between a leader and a follower.', author: 'Steve Jobs' },
        { content: 'Stay hungry, stay foolish.', author: 'Steve Jobs' },
        { content: 'The future belongs to those who believe in the beauty of their dreams.', author: 'Eleanor Roosevelt' },
        { content: 'It is during our darkest moments that we must focus to see the light.', author: 'Aristotle' },
        { content: 'The only thing we have to fear is fear itself.', author: 'Franklin D. Roosevelt' },
        { content: 'In the middle of difficulty lies opportunity.', author: 'Albert Einstein' },
        { content: 'Life is what happens when you are busy making other plans.', author: 'John Lennon' }
      ];
      
      // Try cache first
      if (!forceRefresh) {
        const cached = getCache(CACHE_KEYS.quote);
        if (cached) {
          renderQuote(cached);
          return;
        }
      }
      
      try {
        const res = await fetch('https://api.quotable.io/random?maxLength=100');
        if (!res.ok) throw new Error('API error');
        const q = await res.json();
        
        setCache(CACHE_KEYS.quote, q);
        renderQuote(q);
      } catch (err) {
        // Fallback to local quotes if API fails
        const q = fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)];
        renderQuote(q);
      }
    }
    
    let quoteMode = 'quote'; // 'quote' or 'joke'
    
    function renderQuote(q) {
      const content = el('quoteContent');
      content.innerHTML = `"${q.content}" ‚Äî ${q.author}`;
    }
    
    function renderJokeInline(j) {
      const content = el('quoteContent');
      if (j.type === 'twopart') {
        const escapedSetup = escapeHtml(j.setup);
        const escapedDelivery = escapeHtml(j.delivery).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        content.innerHTML = `${escapedSetup} <span style="color:var(--accent);cursor:pointer" onclick="this.textContent='${escapedDelivery}'">[ÁÇπÂáªÊè≠Êôì]</span>`;
      } else {
        content.textContent = j.joke;
      }
    }

    // Joke API (JokeAPI - free, no key needed)
    let currentJokePunchline = '';
    async function fetchJoke(forceRefresh = false) {
      const fallbackJokes = [
        { setup: 'Why do programmers prefer dark mode?', delivery: 'Because light attracts bugs!' },
        { setup: 'Why do Java developers wear glasses?', delivery: "Because they don't C#!" },
        { setup: 'A SQL query walks into a bar, walks up to two tables and asks...', delivery: '"Can I join you?"' },
        { setup: 'Why did the developer go broke?', delivery: 'Because he used up all his cache!' },
        { setup: "What's a programmer's favorite hangout place?", delivery: 'Foo Bar!' }
      ];
      
      // Try cache first
      if (!forceRefresh) {
        const cached = getCache(CACHE_KEYS.joke);
        if (cached) {
          renderJokeInline(cached);
          return;
        }
      }
      
      try {
        const res = await fetch('https://v2.jokeapi.dev/joke/Programming,Misc,Pun?blacklistFlags=nsfw,religious,political,racist,sexist&type=twopart,single');
        if (!res.ok) throw new Error('API error');
        const j = await res.json();
        
        setCache(CACHE_KEYS.joke, j);
        renderJokeInline(j);
      } catch (err) {
        // Fallback jokes
        const j = fallbackJokes[Math.floor(Math.random() * fallbackJokes.length)];
        renderJokeInline({ type: 'twopart', setup: j.setup, delivery: j.delivery });
      }
    }
    
    function renderJoke(j) {
      const content = el('jokeContent');
      if (j.type === 'twopart') {
        currentJokePunchline = j.delivery;
        const escapedSetup = escapeHtml(j.setup);
        const escapedDelivery = escapeHtml(j.delivery).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
        content.innerHTML = `<span class="joke-text">${escapedSetup} <span class="joke-punchline" onclick="this.textContent='${escapedDelivery}'; this.classList.add('show');">ÁÇπÂáªÊè≠Êôì...</span></span>`;
      } else {
        content.innerHTML = `<span class="joke-text">${escapeHtml(j.joke)}</span>`;
      }
    }

    // Free Dictionary API - enhance vocab card with audio playback
    async function lookupWord(word) {
      try {
        const res = await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/' + encodeURIComponent(word));
        if (!res.ok) return null;
        const data = await res.json();
        return data[0];
      } catch (err) {
        return null;
      }
    }

    // Play pronunciation audio
    async function playPronunciation(e) {
      e.stopPropagation();
      const word = el('vocabWord').textContent;
      if (!word || word === '-') return;
      
      const phoneticEl = el('vocabPhonetic');
      phoneticEl.style.transform = 'scale(0.95)';
      setTimeout(() => phoneticEl.style.transform = '', 150);
      
      try {
        const dictData = await lookupWord(word);
        if (dictData && dictData.phonetics) {
          for (const p of dictData.phonetics) {
            if (p.audio) {
              new Audio(p.audio).play();
              return;
            }
          }
        }
        // Fallback: use browser TTS
        if ('speechSynthesis' in window) {
          const utterance = new SpeechSynthesisUtterance(word);
          utterance.lang = 'en-US';
          speechSynthesis.speak(utterance);
        }
      } catch (err) {
        console.log('Audio playback failed:', err);
      }
    }

    // Event listeners - Quote toggle
    el('toggleQuoteType').onclick = () => {
      quoteMode = quoteMode === 'quote' ? 'joke' : 'quote';
      if (quoteMode === 'quote') {
        fetchQuote(true);
      } else {
        fetchJoke(true);
      }
    };

    // Initialize API features
    fetchWeather();
    fetchQuote();
    
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
  </script>
</body>
</html>
